---
title: "TPQ_R_Python"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = TRUE, cache=FALSE}
options(device = "X11")

library(reticulate)
if (dir.exists("/home/abdulrahman/anaconda3/envs/mne/bin/")){
  use_python ("/home/abdulrahman/anaconda3/envs/mne/bin/python3")
}else{
  #("/home/asawalma/anaconda3/envs/mne/bin/python3")
  use_python("/home/asawalma/anaconda3/bin/python")
}

```

```{python Load all data, include = TRUE}
import numpy as np
import pandas as pd
import os
import matplotlib.pyplot as plt


def prepare_icasso(npz_tpq_path):
    """
    prepare the data from the npz files sent to me by Juergen.
    It creates the following five data frames/groups of data frames:
    data_tpq, data_reco, scores, projections and sources
    All DFs will have column names indicating what they represent
    :param npz_tpq_path: the path to the tpq npz (which is the one that contains the basic info such as IDs)
    :return: five data frames (see description)
    """
    npz_tpq = np.load(npz_tpq_path, allow_pickle=True)
    results_path = npz_tpq_path.replace("icasso_ICA-tpq","icasso-results_ICA-tpq")
    npz_results = np.load(results_path, allow_pickle=True)
    # extract IDs
    IDs = npz_tpq["IDs"]
    diagnoses = []
    trauma = []
    gad = []
    response = []
    ptsd = []
    mdd = []
    session = []
    for i in range(len(IDs)):
        if IDs[i] in list(or_scores["Final ID"]):
            diagnoses.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Diagnosis"])[0])
            trauma.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Trauma"])[0])
            gad.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "GAD"])[0])
            response.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Response"])[0])
            ptsd.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "PTSD"])[0])
            mdd.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "MDD"])[0])
            session.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Session"])[0])
        else:
            diagnoses.append("NA")
            trauma.append("NA")
            gad.append("NA")
            response.append("NA")
            ptsd.append("NA")
            mdd.append("NA")
            session.append("NA")
    # create two data frames to be added to the data inside each dictionary item
    sub_info_2d = [[IDs[i],diagnoses[i],trauma[i], gad[i], response[i], ptsd[i], mdd[i], session[i]] for i in range(len(IDs))]
    sub_info_3d = [sub_info_2d]*npz_results["data_reco"].shape[0]
    sub_info = pd.DataFrame(sub_info_2d, columns=["ID","Diagnosies","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"])
    # read all data
    data_tpq = pd.DataFrame(npz_tpq["data_tpq"])
    data_tpq[["ID","Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"]] = sub_info
    # rename the columns
    data_tpq.columns = ["Q"+str(i) for i in range(1,101)]+["ID","Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"]
    # rearrange the columns, just for aesthetics
    new_colnames = ["ID","Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"] + ["Q"+str(i) for i in range(1,101)]
    data_tpq = data_tpq[new_colnames]
    data_reco = npz_results["data_reco"]
    data_reco = [pd.DataFrame(item, columns=new_colnames) for item in np.append(np.array(sub_info_3d),data_reco,axis = 2)]
    scores = npz_results["scores"]
    projections = npz_results['projection']
    projections = pd.DataFrame(np.append(np.array(sub_info_2d),projections,axis = 1))
    projections.columns = ["ID", "Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"] + ["IC" + str(i) for i in range(1, len(projections.columns) - 7)]
    sources = npz_results["sources"]
    sources = pd.DataFrame(sources, columns = ["Q"+str(i) for i in range(1,101)])
    return(data_tpq, data_reco, scores,projections,sources)
  
# use the scores file to extract diagnoses
scores_path = "/home/asawalma/Insync/abdulrahman.sawalma@gmail.com/Google Drive/PhD/Data/Palestine/TPQ_DataAndAnalysis/TPQ_Analysis_All_25.11.2020_modified.xlsx"
if not os.path.exists(scores_path):
  scores_path = scores_path.replace("/abdulrahman/abdulrahman.sawalma@gmail.com","/asawalma/Insync/abdulrahman.sawalma@gmail.com/Google Drive")
or_scores = pd.read_excel(scores_path)[["Diagnosis","Final ID","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"]]
or_scores.loc[pd.isna(or_scores["Trauma"]),or_scores.columns=="Trauma"] = "NA"
or_scores.loc[pd.isna(or_scores["GAD"]),or_scores.columns=="GAD"] = "NA"
or_scores.loc[pd.isna(or_scores["Response"]),or_scores.columns=="Response"] = "NA"
or_scores.loc[pd.isna(or_scores["PTSD"]),or_scores.columns=="PTSD"] = "NA"
or_scores.loc[pd.isna(or_scores["MDD"]),or_scores.columns=="MDD"] = "NA"

path = '/home/abdulrahman/abdulrahman.sawalma@gmail.com/PhD/Data/Palestine/ICASSO_fixed/decomp_tpq'
if not os.path.exists(path):
    path = path.replace("/abdulrahman/abdulrahman.sawalma@gmail.com","/asawalma/Insync/abdulrahman.sawalma@gmail.com/Google Drive")

all_path = path+'/HC,MDD,PTSD,TNP,GAD_infomax/icasso_ICA-tpq_HC,MDD,PTSD,TNP,GAD_nsamp1822_n_comp13_n_iter100_dist0.40_MNEinfomax.npz'
hc_path  = path + '/HC/icasso_ICA-tpq_HC_nsamp1202_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
mdd_path = path + '/MDD/icasso_ICA-tpq_MDD_nsamp455_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
gad_path = path + '/GAD/icasso_ICA-tpq_GAD_nsamp30_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
ptsd_path = path + '/PTSD/icasso_ICA-tpq_PTSD_nsamp57_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
tnp_path = path + '/TNP/icasso_ICA-tpq_TNP_nsamp78_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
disorders_path = path + '/MDD,PTSD,TNP,GAD/icasso_ICA-tpq_MDD,PTSD,TNP,GAD_nsamp620_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'

data_tpq_all, data_reco_all, scores_all,projections_all,sources_all = prepare_icasso(all_path)
data_tpq_hc, data_reco_hc, scores_hc,projections_hc,sources_hc = prepare_icasso(hc_path)
data_tpq_mdd, data_reco_mdd, scores_mdd,projections_mdd,sources_mdd = prepare_icasso(mdd_path)
data_tpq_gad, data_reco_gad, scores_gad,projections_gad,sources_gad = prepare_icasso(gad_path)
data_tpq_ptsd, data_reco_ptsd, scores_ptsd,projections_ptsd,sources_ptsd = prepare_icasso(ptsd_path)
data_tpq_tnp, data_reco_tnp, scores_tnp,projections_tnp,sources_tnp = prepare_icasso(tnp_path)
data_tpq_disorders, data_reco_disorders, scores_disorders,projections_disorders,sources_disorders = prepare_icasso(disorders_path)

```

```{r  measure the main effect of the factors included (Trauma, MDD, GAD, PTSD and Diagnosis)}
library (ppcor)
library(readxl)
library(reshape2)
library(ggplot2)
library(dplyr)
library(Hmisc)
library(corrplot)
library(abind)

data_tpq_all = py$data_tpq_all
data_reco_all = py$data_reco_all
scores_all = py$scores_all
projections_all = py$projections_all
sources_all = py$sources_all

q_data = data.frame(ifelse(abs(sources_all) > apply(abs(sources_all),2,quantile,0.75),10,NA))
q_data$IC = paste0("IC",1:nrow(q_data))
q_data$IC = factor(q_data$IC, levels = paste0("IC",1:nrow(q_data)))

data_tpq_all$Diagnosis[data_tpq_all$Diagnosis=="NA"] = NA
data_tpq_all$Trauma[data_tpq_all$Trauma=="NA"] = NA
data_tpq_all$GAD[data_tpq_all$GAD=="NA"] = NA
data_tpq_all$Response[data_tpq_all$Response=="NA"] = NA
data_tpq_all$PTSD[data_tpq_all$PTSD=="NA"] = NA
data_tpq_all$MDD[data_tpq_all$MDD=="NA"] = NA

data_tpq_all$Diagnosis = factor(data_tpq_all$Diagnosis)
data_tpq_all$Trauma = factor(data_tpq_all$Trauma)
data_tpq_all$GAD = factor(data_tpq_all$GAD)
data_tpq_all$Response = factor(data_tpq_all$Response)
data_tpq_all$PTSD = factor(data_tpq_all$PTSD)
data_tpq_all$MDD = factor(data_tpq_all$MDD)



# makes data frame separated by diagnosis, cols = questions included, rows = Diagnoses
calc_factor <- function(included_df,fac_name){
  included_df[[fac_name]][included_df[[fac_name]]=="NA"]=NA
  included_df[[fac_name]] = factor(included_df[[fac_name]])
  data_frame = data.frame(sapply(levels(included_df[[fac_name]]), function(x) apply(included_df[included_df[[fac_name]] == x,9:ncol(included_df)],2,mean, na.rm = TRUE)))
  names = sapply(levels(included_df[[fac_name]]), function(x) sum(included_df[[fac_name]] == x, na.rm = TRUE))
  colnames(data_frame) = paste0(colnames(data_frame),"(",names,")")
  data_frame$Question =rownames(data_frame)
  return(data_frame)
}


q_data = data.frame(ifelse(abs(sources_all) > apply(abs(sources_all),1,quantile,0.8),1,NA))
q_data$IC = paste0("IC",1:nrow(q_data))
q_data$IC = factor(q_data$IC, levels = paste0("IC",1:nrow(q_data)))

plot_original <- function(data_score_original, IC_num, Factor){
  ic_included = slice(q_data[IC_num,1:100],rep(1:100, each = nrow(data_score_original)))
  data_ic = data_score_original
  data_ic[,paste0("Q",1:100)] = data_ic[,paste0("Q",1:100)]*ic_included
  data_ic = data_ic[,!is.na(data_ic[1,])]
  
  df_factor = melt(calc_factor(data_ic,Factor), id.vars = "Question", variable.name = "Group", value.name = "MeanScore")
  
  g1 = ggplot(df_factor, aes(x=Question, y = MeanScore, group = Group, color = Group))+
    geom_line(size =1.5)+
    TypicalTheme+
    scale_color_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    scale_x_discrete(name = Factor)
  
  data_means = SMeans(df_factor,"MeanScore","Group")
  g2 = ggplot(data_means,aes(x= Group, y= MeanScore, fill = Group))+
    geom_bar(stat="identity")+
    TypicalTheme+
    scale_fill_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    geom_errorbar(aes(ymin = MeanScore-SEM,ymax = MeanScore+SEM), width = 0.15)+
    scale_x_discrete(name = Factor)
    
  return(multiplot(g1,g2))
}

sapply(1:15, function(x) plot_original(data_tpq_all, x, "Diagnosis"), simplify = FALSE)
sapply(1:15, function(x) plot_original(data_tpq_all, x, "Trauma"), simplify = FALSE)
sapply(1:15, function(x) plot_original(data_tpq_all, x, "GAD"), simplify = FALSE)
sapply(1:15, function(x) plot_original(data_tpq_all, x, "Response"), simplify = FALSE)
sapply(1:15, function(x) plot_original(data_tpq_all, x, "PTSD"), simplify = FALSE)


sapply(1:15, function(x) plot_original(data_tpq_all[data_tpq_all$Session=="Test",], x, "Response"), simplify = FALSE)
sapply(1:15, function(x) plot_original(data_tpq_all[data_tpq_all$Session=="Retest",], x, "Response"), simplify = FALSE)

```

```{r plot projections}

plot_proj <- function(Factor){  
  data = projections_all
  data[,9:ncol(data)] = apply(data[,9:ncol(data)],2,as.numeric)
  
  df_factor = melt(calc_factor(data,Factor), id.vars = "Question", variable.name = "Group", value.name = "MeanScore")
  df_factor$IC = factor(df_factor$Question, levels = paste0("IC",1:15))
  g1 = ggplot(df_factor, aes(x=IC, y = MeanScore, group = Group, color = Group))+
    geom_line(size =1.5)+
    TypicalTheme+
    scale_color_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    scale_x_discrete(name = Factor)
  
  data_means = SMeans(df_factor,"MeanScore","Group")
  g2 = ggplot(data_means,aes(x= Group, y= MeanScore, fill = Group))+
    geom_bar(stat="identity")+
    TypicalTheme+
    scale_fill_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    geom_errorbar(aes(ymin = MeanScore-SEM,ymax = MeanScore+SEM), width = 0.15)+
    scale_x_discrete(name = Factor)
    
  return(multiplot(g1,g2))
}    

sapply(c("Diagnosis","Response","Trauma","GAD","Session"), function(x) plot_proj(x), simplify = FALSE)
```


```{r plot reconstructed data}
library(ggplot2)
library(reshape2)

calc_factor <- function(included_df,fac_name){
  included_df[[fac_name]][included_df[[fac_name]]=="NA"]=NA
  included_df[[fac_name]] = factor(included_df[[fac_name]])
  data_frame = data.frame(sapply(levels(included_df[[fac_name]]), function(x) apply(included_df[included_df[[fac_name]] == x,9:ncol(included_df)],2,mean, na.rm = TRUE)))
  names = sapply(levels(included_df[[fac_name]]), function(x) sum(included_df[[fac_name]] == x, na.rm = TRUE))
  colnames(data_frame) = paste0(colnames(data_frame),"(",names,")")
  data_frame$Question =rownames(data_frame)
  return(data_frame)
}



data_tpq_all = py$data_tpq_all
data_reco_all = py$data_reco_all
scores_all = py$scores_all
projections_all = py$projections_all
sources_all = py$sources_all


q_data = data.frame(ifelse(abs(sources_all) > apply(abs(sources_all),1,quantile,0.8),10,NA))
q_data$IC = paste0("IC",1:nrow(q_data))
q_data$IC = factor(q_data$IC, levels = paste0("IC",1:nrow(q_data)))
sources_melted = melt(sources_all[c(1:100)], value.name = "source_value", variable.name = "Question")

q_data_melted = melt(q_data,id.vars = "IC",variable.name = "Question", value.name = "Included")
q_data_melted$source_value = sources_melted$source_value


plot_reco <- function(IC_num,Factor){
  reco_data = data_reco_all[[IC_num]]
  
  # define columns included, which are the id columns and the included questions
  ID_cols = colnames(reco_data)[1:8]
  
  IC_txt = paste0("IC",IC_num)
  inc_questions = as.character(q_data_melted$Question[q_data_melted$IC == IC_txt&!is.na(q_data_melted$Included)])
  
  data = reco_data[,c(ID_cols,inc_questions)]
  data[,9:ncol(data)] = apply(data[,9:ncol(data)],2,as.numeric)
  
  df_factor = melt(calc_factor(data,Factor), id.vars = "Question", variable.name = "Group", value.name = "MeanScore")
    
  g1 = ggplot(df_factor, aes(x=Question, y = MeanScore, group = Group, color = Group))+
    geom_line(size =1.5)+
    TypicalTheme+
    scale_color_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    scale_x_discrete(name = Factor)
  
  data_means = SMeans(df_factor,"MeanScore","Group")
  g2 = ggplot(data_means,aes(x= Group, y= MeanScore, fill = Group))+
    geom_bar(stat="identity")+
    TypicalTheme+
    scale_fill_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    geom_errorbar(aes(ymin = MeanScore-SEM,ymax = MeanScore+SEM), width = 0.15)+
    scale_x_discrete(name = Factor)
  
  return(multiplot(g1,g2))

}

sapply(1:10, function(x) plot_reco(x, "Diagnosis"), simplify = FALSE)
sapply(1:10, function(x) plot_reco(x, "PTSD"), simplify = FALSE)
sapply(1:10, function(x) plot_reco(x, "Trauma"), simplify = FALSE)
sapply(1:10, function(x) plot_reco(x, "Response"), simplify = FALSE)
sapply(1:10, function(x) plot_reco(x, "GAD"), simplify = FALSE)

```


```{r look at the how do ICs load on Cloningers }
library(ggplot2)
library(reshape2)

data_tpq_all = py$data_tpq_all
data_reco_all = py$data_reco_all
scores_all = py$scores_all
projections_all = py$projections_all
sources_all = py$sources_all


q_data = data.frame(ifelse(abs(sources_all) > apply(abs(sources_all),1,quantile,0.8),10,NA))
q_data$IC = paste0("IC",1:nrow(q_data))
q_data$IC = factor(q_data$IC, levels = paste0("IC",1:nrow(q_data)))
sources_melted = melt(sources_all[c(1:100)], value.name = "source_value", variable.name = "Question")

q_data_melted = melt(q_data,id.vars = "IC",variable.name = "Question", value.name = "Included")
q_data_melted$source_value = sources_melted$source_value

questions_ic_plot = ggplot(q_data_melted,aes(x=Question, group = IC))+
  geom_bar(mapping = aes(y =Included),stat="identity",fill = "#CC6666")+
  geom_line(mapping = aes(y =source_value),size=1.2)+
  facet_grid(IC~.)+
  TypicalTheme+
  theme(axis.text.x = element_text(angle = 90))


TPQQuestions = list(NS1=paste0("Q",c(2, 4, 9, 11, 40, 43, 85, 93, 96)),
                    NS2=paste0("Q",c(30, 46, 48, 50, 55, 56, 81, 99)),
                    NS3=paste0("Q",c(32, 66, 70, 72, 76, 78, 87)),
                    NS4=paste0("Q",c(13, 16, 21, 22, 24, 28, 35, 60, 62, 65)),
                    HA1=paste0("Q",c(1, 5, 8, 10, 14, 82, 84, 91, 95, 98)),
                    HA2=paste0("Q",c(18, 19, 23, 26, 29, 47, 51)),
                    HA3=paste0("Q",c(33, 37, 38, 42, 44, 89, 100)),
                    HA4=paste0("Q",c(49, 54, 57, 59, 63, 68, 69, 73, 75, 80)),
                    RD1=paste0("Q",c(27, 31, 34, 83, 94)),
                    RD2=paste0("Q",c(39, 41, 45, 52, 53, 77, 79, 92, 97)),
                    RD3=paste0("Q",c(3, 6, 7, 12, 15, 64, 67, 74, 86, 88, 90)),
                    RD4=paste0("Q",c(17, 20, 25, 36, 58)),
                    NS=paste0("Q",c(2, 4, 9, 11, 40, 43, 85, 93, 96, 30, 46, 48, 50, 55, 56, 81, 99, 32, 66, 70, 72, 76, 78, 87, 13, 16, 21, 22, 24, 28, 35, 60, 62, 65)),
                    HA=paste0("Q",c(1, 5, 8, 10, 14, 82, 84, 91, 95, 98, 18, 19, 23, 26, 29, 47, 51, 33, 37, 38, 42, 44, 89, 100, 49, 54, 57, 59, 63, 68, 69, 73, 75, 80)),
                    RD=paste0("Q",c(27, 31, 34, 83, 94, 39, 41, 45, 52, 53, 77, 79, 92, 97, 3, 6, 7, 12, 15, 64, 67, 74, 86, 88, 90, 17, 20, 25, 36, 58)))

# Cloninger_match -> percentage of cloninger questions found in each of the ICs (e.g. how much is the percentage of HA1 questions found in IC1)
# IC_match -> percentage of IC questions found in each of Cloningers scales (e.g. how much is the percentage of IC2 questions found in RD3)
Cloninger_match = data.frame(Cloninger_dim = names(TPQQuestions))
IC_match = data.frame(Cloninger_dim = names(TPQQuestions))

for (i in 1:nrow(sources_all)){
  IC_num = paste0("IC",i)
  questions = as.character(q_data_melted$Question[(!is.na(q_data_melted$Included) & q_data_melted$IC == IC_num)])
  Cloninger_match[IC_num] = sapply(TPQQuestions, function(x) sum(x %in% questions)/length(x))
  IC_match[IC_num] = sapply(TPQQuestions, function(x) sum(x %in% questions)/length(questions))
}

Cloninger_melted = melt(Cloninger_match, id.vars = "Cloninger_dim", value.name = "Match_percentage", variable.name = "IC")
Cloninger_melted$Match_percentage[Cloninger_melted$Match_percentage<0.3] = 0

IC_melted = melt(IC_match, id.vars = "Cloninger_dim", value.name = "Match_percentage", variable.name = "IC")
IC_melted$Match_percentage[IC_melted$Match_percentage<0.3] = 0

Clo_g = ggplot(Cloninger_melted, aes(x = Cloninger_dim, y= Match_percentage, group = IC, color = Cloninger_dim))+
  geom_bar(stat="identity")+
  facet_grid(IC~.)


IC_g = ggplot(IC_melted, aes(x = Cloninger_dim, y= Match_percentage, group = IC, color = Cloninger_dim))+
  geom_bar(stat="identity")+
  facet_grid(IC~.)

IC_g
Clo_g

```

```{r compare MDD to combined data in terms of questions included and correlations}
data_tpq_all = py$data_tpq_all
data_reco_all = py$data_reco_all
scores_all = py$scores_all
projections_all = py$projections_all
sources_all = py$sources_all

data_tpq_mdd = py$data_tpq_mdd
data_reco_mdd = py$data_reco_mdd
scores_mdd = py$scores_mdd
projections_mdd = py$projections_mdd
sources_mdd = py$sources_mdd


```


```{r trials}
IC_num = 7
df = data_reco_all[[IC_num]]

IC_txt = paste0("IC",IC_num)
inc_questions = as.character(q_data_melted$Question[q_data_melted$IC == IC_txt&!is.na(q_data_melted$Included)])

reco_data = data_reco_all[[IC_num]]
ID_cols = colnames(reco_data)[1:8]

df = reco_data[,c(ID_cols,inc_questions)]
for (item in c("Diagnosis","Trauma","GAD","Response","PTSD","MDD")){
  df[[item]][df[[item]]=="NA"]=NA
  #df[[item]] = factor(df[[item]])
}


#Do the MDD alone
df$MDD[df$MDD == "No"]=0
df$MDD[df$MDD == "Yes"]=1
df$MDD = as.numeric(df$MDD)

df = df[!is.na(df$MDD),]
Form = as.formula(paste0("MDD ~",paste0(inc_questions,collapse = "+")))
Model = step(glm(Form, data = df, family = binomial()),direction = "both")
summary(Model)
LogisticFunction(Model, returndata = TRUE)

```




