---
title: "TPQ_R_Python"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include = TRUE, cache=FALSE}
options(device = "X11")

library(reticulate)
if (dir.exists("/home/abdulrahman/anaconda3/envs/mne/bin/")){
  use_python ("/home/abdulrahman/anaconda3/envs/mne/bin/python3")
}else{
  #("/home/asawalma/anaconda3/envs/mne/bin/python3")
  use_python("/home/asawalma/anaconda3/bin/python")
}

```

```{python Load all data, include = TRUE}
import numpy as np
import pandas as pd
import os
import matplotlib.pyplot as plt


def prepare_icasso(npz_tpq_path):
    """
    prepare the data from the npz files sent to me by Juergen.
    It creates the following five data frames/groups of data frames:
    data_tpq, data_reco, scores, projections and sources
    All DFs will have column names indicating what they represent
    :param npz_tpq_path: the path to the tpq npz (which is the one that contains the basic info such as IDs)
    :return: five data frames (see description)
    """
    npz_tpq = np.load(npz_tpq_path, allow_pickle=True)
    results_path = npz_tpq_path.replace("icasso_ICA-tpq","icasso-results_ICA-tpq")
    npz_results = np.load(results_path, allow_pickle=True)
    # extract IDs
    IDs = npz_tpq["IDs"]
    diagnoses = []
    trauma = []
    gad = []
    response = []
    ptsd = []
    mdd = []
    session = []
    for i in range(len(IDs)):
        if IDs[i] in list(or_scores["Final ID"]):
            diagnoses.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Diagnosis"])[0])
            trauma.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Trauma"])[0])
            gad.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "GAD"])[0])
            response.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Response"])[0])
            ptsd.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "PTSD"])[0])
            mdd.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "MDD"])[0])
            session.append(list(or_scores.loc[or_scores["Final ID"]==IDs[i], "Session"])[0])
        else:
            diagnoses.append("NA")
            trauma.append("NA")
            gad.append("NA")
            response.append("NA")
            ptsd.append("NA")
            mdd.append("NA")
            session.append("NA")
    # create two data frames to be added to the data inside each dictionary item
    sub_info_2d = [[IDs[i],diagnoses[i],trauma[i], gad[i], response[i], ptsd[i], mdd[i], session[i]] for i in range(len(IDs))]
    sub_info_3d = [sub_info_2d]*npz_results["data_reco"].shape[0]
    sub_info = pd.DataFrame(sub_info_2d, columns=["ID","Diagnosies","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"])
    # read all data
    data_tpq = pd.DataFrame(npz_tpq["data_tpq"])
    data_tpq[["ID","Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"]] = sub_info
    # rename the columns
    data_tpq.columns = ["Q"+str(i) for i in range(1,101)]+["ID","Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"]
    # rearrange the columns, just for aesthetics
    new_colnames = ["ID","Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"] + ["Q"+str(i) for i in range(1,101)]
    data_tpq = data_tpq[new_colnames]
    data_reco = npz_results["data_reco"]
    data_reco = [pd.DataFrame(item, columns=new_colnames) for item in np.append(np.array(sub_info_3d),data_reco,axis = 2)]
    scores = npz_results["scores"]
    projections = npz_results['projection']
    projections = pd.DataFrame(np.append(np.array(sub_info_2d),projections,axis = 1))
    projections.columns = ["ID", "Diagnosis","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"] + ["IC" + str(i) for i in range(1, len(projections.columns) - 7)]
    sources = npz_results["sources"]
    sources = pd.DataFrame(sources, columns = ["Q"+str(i) for i in range(1,101)])
    return(data_tpq, data_reco, scores,projections,sources)
  
# use the scores file to extract diagnoses
scores_path = "/home/asawalma/Insync/abdulrahman.sawalma@gmail.com/Google Drive/PhD/Data/Palestine/TPQ_DataAndAnalysis/TPQ_Analysis_All_25.11.2020_modified.xlsx"
if not os.path.exists(scores_path):
  scores_path = scores_path.replace("/abdulrahman/abdulrahman.sawalma@gmail.com","/asawalma/Insync/abdulrahman.sawalma@gmail.com/Google Drive")
or_scores = pd.read_excel(scores_path)[["Diagnosis","Final ID","Trauma", "GAD", "Response", "PTSD", "MDD", "Session"]]
or_scores.loc[pd.isna(or_scores["Trauma"]),or_scores.columns=="Trauma"] = "NA"
or_scores.loc[pd.isna(or_scores["GAD"]),or_scores.columns=="GAD"] = "NA"
or_scores.loc[pd.isna(or_scores["Response"]),or_scores.columns=="Response"] = "NA"
or_scores.loc[pd.isna(or_scores["PTSD"]),or_scores.columns=="PTSD"] = "NA"
or_scores.loc[pd.isna(or_scores["MDD"]),or_scores.columns=="MDD"] = "NA"

path = '/home/abdulrahman/abdulrahman.sawalma@gmail.com/PhD/Data/Palestine/ICASSO_fixed/decomp_tpq'
if not os.path.exists(path):
    path = path.replace("/abdulrahman/abdulrahman.sawalma@gmail.com","/asawalma/Insync/abdulrahman.sawalma@gmail.com/Google Drive")

all_path = path+'/HC,MDD,PTSD,TNP,GAD_infomax/icasso_ICA-tpq_HC,MDD,PTSD,TNP,GAD_nsamp1822_n_comp13_n_iter100_dist0.40_MNEinfomax.npz'
hc_path  = path + '/HC/icasso_ICA-tpq_HC_nsamp1202_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
mdd_path = path + '/MDD/icasso_ICA-tpq_MDD_nsamp455_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
gad_path = path + '/GAD/icasso_ICA-tpq_GAD_nsamp30_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
ptsd_path = path + '/PTSD/icasso_ICA-tpq_PTSD_nsamp57_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
tnp_path = path + '/TNP/icasso_ICA-tpq_TNP_nsamp78_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'
disorders_path = path + '/MDD,PTSD,TNP,GAD/icasso_ICA-tpq_MDD,PTSD,TNP,GAD_nsamp620_n_comp13_n_iter100_dist0.30_MNEinfomax.npz'

data_tpq_all, data_reco_all, scores_all,projections_all,sources_all = prepare_icasso(all_path)
data_tpq_hc, data_reco_hc, scores_hc,projections_hc,sources_hc = prepare_icasso(hc_path)
data_tpq_mdd, data_reco_mdd, scores_mdd,projections_mdd,sources_mdd = prepare_icasso(mdd_path)
data_tpq_gad, data_reco_gad, scores_gad,projections_gad,sources_gad = prepare_icasso(gad_path)
data_tpq_ptsd, data_reco_ptsd, scores_ptsd,projections_ptsd,sources_ptsd = prepare_icasso(ptsd_path)
data_tpq_tnp, data_reco_tnp, scores_tnp,projections_tnp,sources_tnp = prepare_icasso(tnp_path)
data_tpq_disorders, data_reco_disorders, scores_disorders,projections_disorders,sources_disorders = prepare_icasso(disorders_path)

```

```{r  measure the main effect of the factors included (Trauma, MDD, GAD, PTSD and Diagnosis)}
library (ppcor)
library(readxl)
library(reshape2)
library(ggplot2)
library(dplyr)
library(Hmisc)
library(corrplot)
library(abind)

data_tpq_all = py$data_tpq_all
data_reco_all = py$data_reco_all
scores_all = py$scores_all
projections_all = py$projections_all
sources_all = py$sources_all

data_tpq_all$Diagnosis[data_tpq_all$Diagnosis=="NA"] = NA
data_tpq_all$Trauma[data_tpq_all$Trauma=="NA"] = NA
data_tpq_all$GAD[data_tpq_all$GAD=="NA"] = NA
data_tpq_all$Response[data_tpq_all$Response=="NA"] = NA
data_tpq_all$PTSD[data_tpq_all$PTSD=="NA"] = NA
data_tpq_all$MDD[data_tpq_all$MDD=="NA"] = NA

data_tpq_all$Diagnosis = factor(data_tpq_all$Diagnosis)
data_tpq_all$Trauma = factor(data_tpq_all$Trauma)
data_tpq_all$GAD = factor(data_tpq_all$GAD)
data_tpq_all$Response = factor(data_tpq_all$Response)
data_tpq_all$PTSD = factor(data_tpq_all$PTSD)
data_tpq_all$MDD = factor(data_tpq_all$MDD)



# makes data frame separated by diagnosis, cols = questions included, rows = Diagnoses
calc_factor <- function(included_df,fac_name){
  data_frame = data.frame(sapply(levels(included_df[[fac_name]]), function(x) apply(included_df[included_df[[fac_name]] == x,9:ncol(included_df)],2,mean, na.rm = TRUE)))
  names = sapply(levels(included_df[[fac_name]]), function(x) sum(included_df[[fac_name]] == x, na.rm = TRUE))
  colnames(data_frame) = paste0(colnames(data_frame),"(",names,")")
  data_frame$Question =rownames(data_frame)
  return(data_frame)
}


# include only those who pass the thresold

plot_IC <- function(threshold, IC_num, Factor){
  q_data = data.frame(ifelse(sources_all > apply(abs(sources_all),2,quantile,threshold),1,NA))
  q_data$IC = paste0("IC",1:nrow(q_data))
  q_data$IC = factor(q_data$IC, levels = paste0("IC",1:nrow(q_data)))
  q_data_melted = melt(q_data,id.vars = "IC",variable.name = "Question", value.name = "Included")
  
  questions_ic_plot = ggplot(q_data_melted,aes(x=Question, y =Included))+
    geom_bar(stat="identity",fill = "#CC6666")+
    facet_wrap(~IC,ncol = 1)+
    TypicalTheme
  
  
  ic_included = slice(q_data[IC_num,1:100],rep(1:100, each = nrow(data_tpq_all)))
  data_ic = data_tpq_all
  data_ic[,paste0("Q",1:100)] = data_ic[,paste0("Q",1:100)]*ic_included
  data_ic = data_ic[,!is.na(data_ic[1,])]
  
  df_factor = melt(calc_factor(data_ic,Factor), id.vars = "Question", variable.name = "Group", value.name = "MeanScore")
  
  g1 = ggplot(df_factor, aes(x=Question, y = MeanScore, group = Group, color = Group))+
    geom_line(size =1.5)+
    TypicalTheme+
    scale_color_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    scale_x_discrete(name = Factor)
  
  data_means = SMeans(df_factor,"MeanScore","Group")
  g2 = ggplot(data_means,aes(x= Group, y= MeanScore, fill = Group))+
    geom_bar(stat="identity")+
    TypicalTheme+
    scale_fill_manual(values =  c("#4EA3DF","#6cBE58","#C33E3B","#808CA3","#B9B0AB"))+
    geom_errorbar(aes(ymin = MeanScore-SEM,ymax = MeanScore+SEM), width = 0.15)+
    scale_x_discrete(name = Factor)
    
  return(multiplot(g1,g2))
}

threshold = 0.75
IC_num = 2
Factor = "PTSD"

plot_IC(threshold, 2, Factor)


# look at the projections
# make the previous function accept differnt data frames
```


```{r  look at the projections}
library(ggplot2)

data_tpq_all = py$data_tpq_all
data_reco_all = py$data_reco_all
scores_all = py$scores_all
projections_all = py$projections_all
sources_all = py$sources_all

projections_all
```